#!/usr/bin/env python
# -*- coding: utf-8 -*-
import signal
import nfc
import binascii
from time import sleep
import serial
import time


f_level = False


def remote(ser, cmd):
    global f_level
    if(cmd == 'spray'):
        if(f_level == True):
            print('Level: puls')
            # level Plus
            ser.write(b's,5924,3028,500,664,468,1716,500,684,452,656,448,684,444,664,444,664,472,664,444,656,452,684,452,656,448,1744,492,664,472,664,444,664,444,1748,492,656,480,1736,496,664,444,664,444,684,452,656,452,656,472,660,444,664,444,1752,492,684,448,660,448,656,480,656,444,664,444,1748,492,684,452,656,452,656,472,664,444,664,444,692,444,656,448,40060,5924,3036,500,656,472,1720,492,692,444,664,444,696,440,668,436,672,460,660,444,664,444,692,444,656,452,1744,496,656,472,664,444,664,444,1748,492,672,464,1716,524,672,432,660,444,700,436,664,444,664,472,668,440,656,448,1744,492,692,444,668,440,664,468,660,448,672,436,1748,488,696,440,664,440,680,456,672,436,672,436,696,432,664,444,40016,5968,3040,492,660,476,1736,480,684,444,660,444,692,444,672,436,656,480,656,444,664,444,692,444,664,444,1748,492,664,472,656,444,664,444,1768,472,664,472,1720,520,672,436,672,436,696,432,676,432,668,464,672,436,672,436,1748,500,692,428,672,436,672,464,672,436,672,436,1764,476,700,428,680,428,672,464,668,440,668,436,700,436,672,428,0,')
            ser.write(b's,5924,3028,500,664,468,1716,500,684,452,656,448,684,444,664,444,664,472,664,444,656,452,684,452,656,448,1744,492,664,472,664,444,664,444,1748,492,656,480,1736,496,664,444,664,444,684,452,656,452,656,472,660,444,664,444,1752,492,684,448,660,448,656,480,656,444,664,444,1748,492,684,452,656,452,656,472,664,444,664,444,692,444,656,448,40060,5924,3036,500,656,472,1720,492,692,444,664,444,696,440,668,436,672,460,660,444,664,444,692,444,656,452,1744,496,656,472,664,444,664,444,1748,492,672,464,1716,524,672,432,660,444,700,436,664,444,664,472,668,440,656,448,1744,492,692,444,668,440,664,468,660,448,672,436,1748,488,696,440,664,440,680,456,672,436,672,436,696,432,664,444,40016,5968,3040,492,660,476,1736,480,684,444,660,444,692,444,672,436,656,480,656,444,664,444,692,444,664,444,1748,492,664,472,656,444,664,444,1768,472,664,472,1720,520,672,436,672,436,696,432,676,432,668,464,672,436,672,436,1748,500,692,428,672,436,672,464,672,436,672,436,1764,476,700,428,680,428,672,464,668,440,668,436,700,436,672,428,0,')
        else:
            ser.write(b's,5924,3036,496,656,472,1744,472,688,444,664,444,684,452,656,452,656,472,664,444,664,444,684,448,660,448,1744,500,656,472,664,444,660,444,692,444,656,452,1764,476,660,468,664,444,664,444,692,444,664,444,1740,500,656,452,684,444,664,444,692,444,664,440,660,476,660,448,1744,492,664,444,1748,492,664,472,656,452,656,452,684,444,664,440,40068,5916,3044,492,664,472,1720,492,684,452,656,444,692,444,664,440,660,476,656,452,656,444,692,444,664,444,1756,484,664,472,656,452,656,452,684,444,664,444,1748,492,664,472,656,452,656,444,692,444,660,444,1764,480,656,452,684,448,660,444,688,444,664,444,664,472,656,452,1748,492,656,452,1748,484,668,468,664,444,664,444,696,440,656,444,40088,5896,3036,500,684,448,1724,520,656,444,664,444,688,444,664,444,664,472,656,452,656,472,664,444,664,444,1748,492,664,472,656,452,656,472,664,444,664,444,1768,472,664,472,656,448,660,448,684,444,664,444,1772,472,660,472,656,452,656,452,684,444,664,444,692,444,656,452,1740,500,656,452,1740,496,676,456,664,444,664,472,656,452,656,452,0,')
            ser.write(b's,5924,3036,496,656,472,1744,472,688,444,664,444,684,452,656,452,656,472,664,444,664,444,684,448,660,448,1744,500,656,472,664,444,660,444,692,444,656,452,1764,476,660,468,664,444,664,444,692,444,664,444,1740,500,656,452,684,444,664,444,692,444,664,440,660,476,660,448,1744,492,664,444,1748,492,664,472,656,452,656,452,684,444,664,440,40068,5916,3044,492,664,472,1720,492,684,452,656,444,692,444,664,440,660,476,656,452,656,444,692,444,664,444,1756,484,664,472,656,452,656,452,684,444,664,444,1748,492,664,472,656,452,656,444,692,444,660,444,1764,480,656,452,684,448,660,444,688,444,664,444,664,472,656,452,1748,492,656,452,1748,484,668,468,664,444,664,444,696,440,656,444,40088,5896,3036,500,684,448,1724,520,656,444,664,444,688,444,664,444,664,472,656,452,656,472,664,444,664,444,1748,492,664,472,656,452,656,472,664,444,664,444,1768,472,664,472,656,448,660,448,684,444,664,444,1772,472,660,472,656,452,656,452,684,444,664,444,692,444,656,452,1740,500,656,452,1740,496,676,456,664,444,664,472,656,452,656,452,0,')
    elif(cmd == 'STOP'):
        if(f_level == True):
            print('level: minus')
            # level minus
            ser.write(b's,5992,2968,568,588,540,1652,560,616,452,668,508,616,516,588,512,604,532,596,444,672,436,696,508,600,508,1680,560,588,540,600,508,596,512,616,440,668,440,1756,564,588,540,600,436,672,508,628,504,604,496,604,464,664,512,1680,560,604,504,628,432,676,508,600,528,600,508,592,444,684,460,664,504,632,428,672,512,596,532,600,508,600,436,42300,5996,2964,568,588,540,1656,560,620,512,588,520,616,512,596,444,664,540,596,512,596,512,616,444,664,512,1680,568,588,540,592,516,592,516,612,444,664,512,1688,492,656,540,596,444,664,444,684,520,588,444,664,540,596,444,1768,540,596,512,616,512,596,520,588,468,664,444,664,444,684,452,656,520,616,444,664,520,588,472,660,444,660,516,42244,5912,3036,492,664,472,1728,484,692,444,664,444,684,444,664,444,664,544,588,444,664,444,692,512,588,452,1748,484,664,472,664,444,664,444,684,448,660,448,1752,484,664,472,664,444,664,444,684,448,660,444,660,472,664,444,1756,484,664,444,684,520,588,444,664,472,664,444,664,444,692,444,656,448,688,440,664,444,664,472,664,444,664,444,0,')
            ser.write(b's,5992,2968,568,588,540,1652,560,616,452,668,508,616,516,588,512,604,532,596,444,672,436,696,508,600,508,1680,560,588,540,600,508,596,512,616,440,668,440,1756,564,588,540,600,436,672,508,628,504,604,496,604,464,664,512,1680,560,604,504,628,432,676,508,600,528,600,508,592,444,684,460,664,504,632,428,672,512,596,532,600,508,600,436,42300,5996,2964,568,588,540,1656,560,620,512,588,520,616,512,596,444,664,540,596,512,596,512,616,444,664,512,1680,568,588,540,592,516,592,516,612,444,664,512,1688,492,656,540,596,444,664,444,684,520,588,444,664,540,596,444,1768,540,596,512,616,512,596,520,588,468,664,444,664,444,684,452,656,520,616,444,664,520,588,472,660,444,660,516,42244,5912,3036,492,664,472,1728,484,692,444,664,444,684,444,664,444,664,544,588,444,664,444,692,512,588,452,1748,484,664,472,664,444,664,444,684,448,660,448,1752,484,664,472,664,444,664,444,684,448,660,444,660,472,664,444,1756,484,664,444,684,520,588,444,664,472,664,444,664,444,692,444,656,448,688,440,664,444,664,472,664,444,664,444,0,')
        else:
            ser.write(b's,5984,2984,604,524,608,1608,544,604,532,576,532,608,580,528,520,588,548,588,580,524,520,616,520,580,584,1632,608,528,608,524,584,524,580,1636,600,532,540,1676,628,528,580,1632,608,528,580,1628,616,520,544,1676,600,1640,604,524,548,1668,608,1592,640,556,580,1572,668,528,580,528,580,1660,548,1664,568,1676,600,528,548,588,544,560,548,560,612,30980,6008,2916,612,560,572,1608,608,588,544,564,544,588,548,552,548,560,576,560,548,560,548,588,548,560,544,1628,608,560,576,560,548,560,548,1664,576,560,568,1644,596,560,548,1668,572,560,548,1668,576,560,568,1644,576,1668,564,564,572,1640,576,1624,616,588,548,1636,604,552,548,560,548,1632,608,1668,576,1664,576,560,548,580,548,560,548,560,572,30984,6040,2960,576,580,548,1644,604,552,548,560,548,588,548,560,548,560,572,556,552,556,572,560,548,560,548,1668,572,560,576,540,560,560,576,1596,616,588,548,1600,640,560,548,1628,612,556,552,1660,576,560,576,1640,572,1676,568,580,552,1660,580,1640,576,580,548,1640,600,560,548,560,576,1640,572,1668,576,1664,568,556,580,560,548,560,548,588,540,30984,6040,2920,616,552,580,1600,608,588,548,560,548,588,548,560,544,564,572,540,560,564,544,588,548,560,548,1668,572,560,576,552,556,552,548,588,548,560,548,544,588,556,552,556,572,560,548,560,548,588,548,560,548,552,580,556,548,560,572,560,548,560,548,588,548,552,556,552,576,560,548,560,544,588,548,560,548,580,548,560,548,560,576,44432,6012,2948,576,560,576,1640,572,584,552,556,544,588,548,560,548,560,576,560,548,552,548,588,548,560,544,1676,568,560,572,556,552,556,552,568,560,560,548,560,576,560,548,560,576,552,548,560,548,588,544,564,544,560,576,552,556,552,576,560,548,560,548,588,544,560,548,560,576,552,548,560,548,588,548,560,548,580,556,552,552,556,572,44436,6008,2956,572,560,576,1640,600,560,548,552,556,580,548,560,548,560,576,560,544,564,572,556,552,556,544,1668,576,560,572,560,548,560,548,580,556,552,556,580,548,560,548,560,572,556,552,556,552,576,552,548,560,588,548,560,548,560,576,552,552,556,548,588,544,564,544,560,576,552,556,552,576,560,548,560,548,572,560,564,544,560,576,0,')
            ser.write(b's,5984,2984,604,524,608,1608,544,604,532,576,532,608,580,528,520,588,548,588,580,524,520,616,520,580,584,1632,608,528,608,524,584,524,580,1636,600,532,540,1676,628,528,580,1632,608,528,580,1628,616,520,544,1676,600,1640,604,524,548,1668,608,1592,640,556,580,1572,668,528,580,528,580,1660,548,1664,568,1676,600,528,548,588,544,560,548,560,612,30980,6008,2916,612,560,572,1608,608,588,544,564,544,588,548,552,548,560,576,560,548,560,548,588,548,560,544,1628,608,560,576,560,548,560,548,1664,576,560,568,1644,596,560,548,1668,572,560,548,1668,576,560,568,1644,576,1668,564,564,572,1640,576,1624,616,588,548,1636,604,552,548,560,548,1632,608,1668,576,1664,576,560,548,580,548,560,548,560,572,30984,6040,2960,576,580,548,1644,604,552,548,560,548,588,548,560,548,560,572,556,552,556,572,560,548,560,548,1668,572,560,576,540,560,560,576,1596,616,588,548,1600,640,560,548,1628,612,556,552,1660,576,560,576,1640,572,1676,568,580,552,1660,580,1640,576,580,548,1640,600,560,548,560,576,1640,572,1668,576,1664,568,556,580,560,548,560,548,588,540,30984,6040,2920,616,552,580,1600,608,588,548,560,548,588,548,560,544,564,572,540,560,564,544,588,548,560,548,1668,572,560,576,552,556,552,548,588,548,560,548,544,588,556,552,556,572,560,548,560,548,588,548,560,548,552,580,556,548,560,572,560,548,560,548,588,548,552,556,552,576,560,548,560,544,588,548,560,548,580,548,560,548,560,576,44432,6012,2948,576,560,576,1640,572,584,552,556,544,588,548,560,548,560,576,560,548,552,548,588,548,560,544,1676,568,560,572,556,552,556,552,568,560,560,548,560,576,560,548,560,576,552,548,560,548,588,544,564,544,560,576,552,556,552,576,560,548,560,548,588,544,560,548,560,576,552,548,560,548,588,548,560,548,580,556,552,552,556,572,44436,6008,2956,572,560,576,1640,600,560,548,552,556,580,548,560,548,560,576,560,544,564,572,556,552,556,544,1668,576,560,572,560,548,560,548,580,556,552,556,580,548,560,548,560,572,556,552,556,552,576,552,548,560,588,548,560,548,560,576,552,552,556,548,588,544,564,544,560,576,552,556,552,576,560,548,560,548,572,560,564,544,560,576,0,')
    elif(cmd == 'level'):
        if(f_level == False):
            print 'level mode ON'
            f_level = True
        else:
            print'level mode OFF'
            f_level = False


def on_connect(tag):
    # カードの固有idの定義
    cardId1 = '***********'
    cardId2 = '***********'
    cardId3 = '***********'

    ser = serial.Serial('/dev/ttyUSB1', 57600)
    sleep(1)
    # print tag
    # print tag.type
    cardID = binascii.hexlify(tag.identifier).upper()
    if(cardID == cardId1):
        remote(ser, 'level')
    elif(cardID == cardId2):
        print 'student card: spray'
        remote(ser, 'spray')
    elif(cardID == cardId3):
        print 'PASMO: stop'
        remote(ser, 'STOP')


def main():
    with nfc.ContactlessFrontend('usb') as clf:
        clf.connect(rdwr={'on-connect': on_connect})


if __name__ == '__main__':
    try:
        while True:
            main()
    except KeyboardInterrupt:
        sys.exit(0)
